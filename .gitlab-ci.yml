image: gitlab.pilichiewicz.pl:5050/dockercorewindows/builder_choco:latest

stages:
  - deploy

deploy:
  stage: deploy
  script:
    - $f='tools/chocolateyinstall.ps1'
    - gc $f | ? {$_ -notmatch "^\s*#"} | % {$_ -replace '(^.*?)\s*?[^``]#.*','$1'} | Out-File $f+".~" -en utf8; mv -fo $f+".~" $f

    - $f='tools/chocolateyuninstall.ps1'
    - gc $f | ? {$_ -notmatch "^\s*#"} | % {$_ -replace '(^.*?)\s*?[^``]#.*','$1'} | Out-File $f+".~" -en utf8; mv -fo $f+".~" $f

    - $f='tools/chocolateybeforemodify.ps1'
    - gc $f | ? {$_ -notmatch "^\s*#"} | % {$_ -replace '(^.*?)\s*?[^``]#.*','$1'} | Out-File $f+".~" -en utf8; mv -fo $f+".~" $f

    - choco pack
    - Copy-Item -Path *.nupkg -Destination \\pilisrvfile01.pilichiewicz.local\exchange\;

    - git commit -m "Update Files"
    - git push origin HEAD:$CI_COMMIT_REF_NAME

  only:
    - master
